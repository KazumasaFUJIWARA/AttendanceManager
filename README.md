# 出席管理システム

## 概要
このプロジェクトは、学生の出席状況を管理するためのWebアプリケーションです。リアルタイムでの出席記録、コアタイム管理、アラート機能を提供します。

## 主な機能
- 学生の出席記録（入室・退室）
- コアタイム管理（8:30-17:30）
- リアルタイムの出席状況表示
- アラート機能（コアタイム違反、長時間滞在）
- 出席履歴の確認
- 学生情報の管理

## 技術スタック
- バックエンド: FastAPI (Python)
- フロントエンド: HTML, CSS, JavaScript
- データベース: SQLite
- コンテナ化: Docker

## セットアップ手順

### 1. リポジトリのクローン
```bash
git clone https://github.com/KazumasaFUJIWARA/AttendanceManager.git
cd AttendanceManager
```

### 2. 環境変数の設定
`.env`ファイルを作成し、以下の内容を設定します：
```
DATABASE_URL=sqlite:///./attendance.db
```

### 3. Docker環境の構築
```bash
docker-compose up -d
```

### 4. アプリケーションの起動
サーバーが自動的に起動し、以下のURLでアクセス可能になります：
- API: http://localhost:8889
- Swagger UI: http://localhost:8889/docs
- フロントエンド: http://localhost:8889/index.html

## API エンドポイント

### 学生管理
- `POST /api/students/` - 学生の登録
- `GET /api/students/{student_id}` - 学生情報の取得
- `GET /api/students/` - 全学生の一覧取得

### 出席管理
- `POST /api/attendance/` - 出席記録の作成
- `GET /api/attendance/{student_id}` - 学生の出席履歴取得
- `GET /api/attendance/current/{student_id}` - 現在の出席状況取得

### コアタイム管理
- `GET /api/core-time/` - コアタイム情報の取得
- `GET /api/core-time/violations/` - コアタイム違反の一覧取得

### アラート
- `GET /api/alerts/` - アラート一覧の取得

## フロントエンド機能
- リアルタイムの出席状況表示
- 学生の入室・退室記録
- 出席履歴の表示
- コアタイム違反の表示
- アラート通知

## フロントエンド実装詳細 (app.js)

### 概要
app.jsは出席管理システムのフロントエンド部分を担当するJavaScriptファイルです。学生の出席状況をリアルタイムで表示し、定期的にデータを更新します。

### 主要機能
- **自動データ更新**: ページ読み込み時にデータを取得し、1分ごとに自動更新
- **学生データ表示**: 学生ID、名前、現在の入室状況、今週の利用時間、コアタイム情報を表示
- **コアタイム管理**: 学生ごとのコアタイム情報（曜日と時限）を表示
- **エラーハンドリング**: データ取得失敗時のエラー表示と再読み込み機能

### API連携
- `/api/students/`: 学生一覧の取得
- `/api/current-status/`: 現在の入室状況の取得
- `/api/attendance/{student_id}?days=7`: 学生ごとの出席履歴（過去7日間）の取得

### 表示項目
1. **学生ID**: 学生の識別番号
2. **名前**: 学生の氏名
3. **入室状況**: 「入室中」または「退室中」を表示（リアルタイム更新）
4. **利用時間**: 今週の合計利用時間（時間単位で小数点1桁まで表示）
5. **コアタイム1**: 1つ目のコアタイム（曜日と時限）
6. **コアタイム2**: 2つ目のコアタイム（曜日と時限）
7. **違反回数**: コアタイム違反の回数（違反がある場合は強調表示）

### データ更新ロジック
1. 学生一覧を取得
2. 現在の入室状況を取得
3. 今週の日付範囲を計算（日曜日から現在まで）
4. 各学生について:
   - 現在の入室状況を確認
   - 今週の出席履歴を取得
   - 利用時間を計算（入室時間と退室時間の差分）
   - コアタイム情報を整形して表示

### エラー処理
- APIリクエスト失敗時: エラーメッセージを表示し、再読み込みボタンを提供
- 個別の学生データ取得失敗時: エラーをログに記録し、他の学生のデータ表示は継続

### 関数仕様

#### 1. `loadStudentData()`
- **目的**: 学生データを取得し、画面に表示する
- **戻り値**: なし（非同期関数）
- **処理内容**:
  1. 学生一覧をAPIから取得
  2. 現在の入室状況をAPIから取得
  3. 今週の日付範囲を計算（日曜日から現在まで）
  4. 各学生について:
     - 現在の入室状況を確認
     - 今週の出席履歴を取得
     - 利用時間を計算
     - コアタイム情報を整形
     - テーブル行を作成して表示
- **エラー処理**:
  - APIリクエスト失敗時: エラーメッセージを表示し、再読み込みボタンを提供
  - 個別の学生データ取得失敗時: エラーをログに記録し、他の学生のデータ表示は継続

#### 2. `formatCoreTime(day, period)`
- **目的**: コアタイムの曜日と時限を日本語表記に整形する
- **引数**:
  - `day`: 曜日を表す数値（0: 日曜日, 1: 月曜日, ..., 6: 土曜日）
  - `period`: 時限を表す数値（1: 1限, 2: 2限, ..., 6: 6限）
- **戻り値**: 整形されたコアタイム文字列（例: 「月曜1限」）または「-」（値がない場合）
- **処理内容**:
  1. 引数が無効な場合（null, undefined, 0）は「-」を返す
  2. 曜日と時限を日本語表記に変換して結合する

#### 3. イベントリスナー（DOMContentLoaded）
- **目的**: ページ読み込み時に初期データを取得し、定期的な更新を設定する
- **処理内容**:
  1. ページ読み込み時に`loadStudentData()`を実行
  2. 1分ごとに`loadStudentData()`を実行するタイマーを設定

### 定数
- **API_BASE_URL**: APIのベースURL（'/api'）
- **DAYS_OF_WEEK**: 曜日の日本語表記配列（['日', '月', '火', '水', '木', '金', '土']）
- **PERIODS**: 時限の日本語表記配列（['', '1限', '2限', '3限', '4限', '5限', '6限']）

## 開発環境
- Python 3.8以上
- Docker
- Docker Compose

## ライセンス
MIT License

## 作者
Kazumasa FUJIWARA
